@using Entidades;
@model ENPerfiles
@{
    ViewBag.Title = "Perfiles";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section Styles {
    @Styles.Render("~/Content/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css")
    @Styles.Render("~/Content/plugins/datatables-responsive/css/responsive.bootstrap4.min.css")
    @Styles.Render("~/Content/plugins/sweetalert2/sweetalert2.min.css")
    @Styles.Render("~/Content/plugins/select2/css/select2.min.css")
}

<div class="row">
    <input type="hidden" id="soloAsegurados_ruta" name="name" value='@Url.Action("getPerfiles", "Perfiles")' />
    <div class="col col-md-12">
        <div class="card card-gray">
            <div class="card-header">
                <div class="col text-left">
                    <h5 class="card-title">
                        <i class="fas fa-table"></i>
                        Perfiles
                    </h5>
                </div>
                <div class="col text-right">
                    <button type="button" id="btnPerfilNuevo" class="btn btn-flat btn-primary btn-sm" data-dismiss="modal" data-toggle="modal">
                        <i class="fa fa-plus-circle text-warning"></i>
                        Agregar Perfil
                    </button>
                </div>                
            </div>
            <!-- /.card-header -->
            <div class="card-body ">
                @using (Html.BeginForm("Index", "Perfiles", FormMethod.Post))
                {
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="txtBusquedaPerfiles">Búsqueda:</label>
                                <input type="text" id="txtBusquedaPerfiles" class="form-control form-control-sm" name="txtBusquedaPerfiles" placeholder="Descripción" />
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label style="visibility:hidden;">Búsqueda:</label>
                                <div>
                                    <button type="submit" class="btn btn-dark btn-sm">
                                        <i class="fa fa-search-plus text-warning"></i>&nbsp;&nbsp;Buscar Perfil
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4"></div>
                    </div>
                    <hr />
                    <div class="row">
                        <div class="col d-flex justify-content-start">
                            <div class="col text-left">
                                <label class="text-bold text-primary">PÁGINA </label>&nbsp;
                                <label class="text-bold" style="font-size:9pt">(@Convert.ToInt32(ViewData["pageCount"]) DE @(Convert.ToInt32(ViewData["ultimo"])+1))</label>&nbsp;&nbsp;
                                <i class="fa fa-angle-double-right text-warning"></i>
                                <label class="text-bold text-success" style="font-size:9pt">Perfiles disponibles</label>&nbsp;
                                <label class="text-bold" style="font-size:9pt">(@Convert.ToInt32(ViewData["todos"]))</label>
                            </div>
                        </div>
                        <div class="col d-flex justify-content-end">
                            <ul class="pagination">
                                <li class="page-item success">
                                    <a class="page-link" href="@Url.Action("Index", new { page = 1 })">&nbsp;&nbsp;Pág. 1</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="@Url.Action("Index", new { page = Convert.ToInt32(ViewData["pageCount"]) - 1 })">&nbsp;&nbsp;<i class="fa fa-angle-left text-primary"></i>&nbsp;&nbsp;Anterior</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="@Url.Action("Index", new { page = Convert.ToInt32(ViewData["pageCount"]) + 1 })">Siguiente&nbsp;&nbsp;<i class="fa fa-angle-right text-primary"></i></a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="@Url.Action("Index", new { page = Convert.ToInt32(ViewData["ultimo"]) + 1 })">Pág. @(Convert.ToInt32(ViewData["ultimo"])+1)&nbsp;&nbsp;</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="row">
                        <div class="table-responsive">
                            <table id="dglista" class="table table-bordered">
                                <thead class="bg-primary">
                                    <tr>
                                        <th>CODIGO PERFIL</th>
                                        <th>DESCRIPCION</th>
                                        <th>DESCRIPCION CORTA</th>
                                        <th>TIPO CLIENTE</th>
                                        <th>FECHA INICIO</th>
                                        <th>FECHA FIN</th>
                                        <th>GENERA ORDEN</th>
                                        <th>NIVEL ATENCIÓN</th>
                                        <th>EDITAR</th>
                                        <th>ELIMINAR</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (ViewBag.Perfiles != null)
                                    {
                                        foreach (ENPerfiles perfil in (List<ENPerfiles>)ViewBag.Perfiles)
                                        {
                                            <tr>
                                                <td class="cellCodigoCliente">@perfil.CodigoPerfil </td>
                                                <td class="cellCodigoTitular">@perfil.DescripcionPerfil </td>
                                                <td class="cellCodigoTitular">@perfil.DescripcionCorta </td>
                                                <td>@perfil.CodigoTipoCliente </td>
                                                <td>@perfil.FechaInicio.ToString("yyyy-MM-dd") </td>
                                                <td>@perfil.FechaFin.ToString("yyyy-MM-dd") </td>
                                                <td>@perfil.GeneraOrden </td>
                                                <td>@perfil.NivelAtencion </td>
                                                <td class="text-center">
                                                    <button type="button" class="botonedit btn btn-success btn-sm" onclick='EditarPerfil(event);' data-request-url='@Url.Action("Mantenimiento", "SaludAsegurados")'>
                                                        <i class="fa fa-edit text-warning"></i>&nbsp;Editar
                                                    </button>
                                                </td>
                                                <td class="text-center">
                                                    <button type="button" class="botonedit btn btn-danger btn-sm" onclick='EliminarPerfil(event);' data-request-url='@Url.Action("Mantenimiento", "SaludAsegurados")'>
                                                        <i class="fa fa-times text-warning"></i>&nbsp;Eliminar
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
            </div>
            <!-- /.card-body -->
        </div>
    </div>

</div>

<div class="modal fade-scale" id="modalNuevoPerfil" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="exampleModalLabel"><i class="fa fa-7x fa-plus  text-warning"></i>&nbsp;&nbsp;Perfil</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                @using (Html.BeginForm("Guardar", "Perfiles", FormMethod.Post, new { id = "Form2", onsubmit = "return validateForm2()" }))
                {
                    <div class="pl-4 pr-4 pt-1 pb-1">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <h6>Nombre Perfil :</h6>
                                    @Html.HiddenFor(model => model.CodigoPerfil, new { id = "hfCodigoPerfil" })
                                    @Html.TextBoxFor(model => model.DescripcionPerfil, new { @class = "form-control form-control-sm", id = "txtDescripcionPerfil", @placeholder = "Descripción de perfil" })
                                    @Html.ValidationMessageFor(model => model.DescripcionPerfil, "", new { @class = "text-danger" })
                                </div>
                                <div class="form-group">
                                    <h6>Tipo Cliente :</h6>
                                    @Html.DropDownListFor(model => model.CodigoTipoCliente, ViewData["TiposCliente"] as SelectList, new { @class = "form-control form-control-sm js-example-basic-single", id = "ddlCodigoTipoCliente", @style = "width:100%", @readonly= true })
                                    @Html.ValidationMessageFor(model => model.CodigoTipoCliente, "", new { @class = "text-danger" })
                                </div>
                                <div class="form-group">
                                    <h6>Fecha Inicio :</h6>
                                    @Html.TextBoxFor(model => model.FechaInicio, "{0:yyyy-MM-dd}", new { type = "date", id = "txtFechaInicio", @class = "form-control form-control-sm float-right", @Value = System.DateTime.Now.ToString("yyyy-MM-dd") })
                                    @Html.ValidationMessageFor(model => model.FechaInicio, "", new { @class = "text-danger" })
                                </div>
                                <div class="form-group">
                                    <h6>Fecha Fin :</h6>
                                    @Html.TextBoxFor(model => model.FechaFin, "{0:yyyy-MM-dd}", new { type = "date", id = "txtFechaFin", @class = "form-control form-control-sm float-right", @Value = System.DateTime.Now.ToString("yyyy-MM-dd") })
                                    @Html.ValidationMessageFor(model => model.FechaFin, "", new { @class = "text-danger" })
                                </div>
                                <div class="form-group" hidden>
                                    <h6>Genera Orden :</h6>
                                    @Html.DropDownListFor(m => m.GeneraOrden, new List<SelectListItem>
                                    {
                                        new SelectListItem { Text = "NO", Value = "0"},
                                        new SelectListItem { Text = "SI", Value = "1"},
                                    }, new { @class = "form-control form-control-sm js-example-basic-single", id = "ddlGeneraOrden", @style = "width:100%" })
                                    @Html.ValidationMessageFor(model => model.GeneraOrden, "", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr />
                    <div class="form-group">
                        <button type="submit" class="btn btn-dark btn-sm">
                            <i class="fa fa-building text-warning"></i>&nbsp;&nbsp;Guardar Datos
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/Content/plugins/datatables/jquery.dataTables.min.js")
    @Scripts.Render("~/Content/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js")
    @Scripts.Render("~/Content/plugins/datatables-responsive/js/dataTables.responsive.min.js")
    @Scripts.Render("~/Content//plugins/datatables-responsive/js/responsive.bootstrap4.min.js")
    @Scripts.Render("~/Content/plugins/sweetalert2/sweetalert2.min.js")
    @Scripts.Render("~/Content/plugins/select2/js/select2.full.min.js")
    @Scripts.Render("~/Scripts/Shared/util.js")


    <script>

        $(document).ready(function () {
            $('.js-example-basic-single').select2();

            var mensaje = "@TempData["Mensaje"]";
            mostrarMensaje(mensaje);
        });

    </script>

    <script>
        $(function () {
            var tablaLista
            tablaLista = $('#dglista').DataTable({
                "paging": true,
                "lengthChange": false,
                "ordering": true,
                "info": true,
                "autoWidth": false,
                "responsive": false,
                "lengthMenu": [[5, 10, 50, -1], [5, 10, 50, "Todos"]],
                "pageLength": 8,
                "searching": false,
                "language": {
                    "url": "https://cdn.datatables.net/plug-ins/1.10.21/i18n/Spanish.json"
                }
            });
        });
    </script>
    <script>

        $('#btnPerfilNuevo').click(function () {
            $('#modalNuevoPerfil').modal('show');
            document.forms["Form2"]["txtDescripcionPerfil"].value = "";
            document.getElementById("ddlCodigoTipoCliente").value = "09";
            var date = new Date();
            document.getElementById("txtFechaInicio").value = date.toISOString().split('T')[0];;
            document.getElementById("txtFechaFin").value = date.toISOString().split('T')[0];;
            document.getElementById("ddlGeneraOrden").value = "0";
        });

        function validateForm2() {
            //--
            var descrip = document.forms["Form2"]["DescripcionPerfil"].value.trim();
            //---
            if (descrip == "") {
                Swal.fire({
                    icon: 'warning',
                    title: 'Advertencia',
                    text: 'Ingrese descripción de perfil',
                    showCloseButton: true
                })
                return false;
            }
        }

        function EditarPerfil(e) {
            e.preventDefault();
            document.getElementById("txtDescripcionPerfil").value = "";
            if (e.target.classList.contains('botonedit'))
            {
                const scodigoPerfil = e.target.parentElement.parentElement.firstElementChild.textContent;
                const sdescripcion = e.target.parentElement.parentElement.firstElementChild.nextElementSibling.textContent;
                const stipoCliente = e.target.parentElement.parentElement.firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.textContent.trim();
                const sfechaInicio = e.target.parentElement.parentElement.firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.nextElementSibling.textContent.trim();
                const sfechaFin = e.target.parentElement.parentElement.firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.nextElementSibling.nextElementSibling.textContent.trim();
                const sGeneraOrden = e.target.parentElement.parentElement.firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.nextElementSibling.nextElementSibling.nextElementSibling.textContent;
                //console.log(stipoCliente);
                $('#modalNuevoPerfil').modal('show');
                document.getElementById("hfCodigoPerfil").value = scodigoPerfil;
                document.getElementById("txtDescripcionPerfil").value = sdescripcion;

                //$("#ddlCodigoTipoCliente").val(stipoCliente);
                document.getElementById("ddlCodigoTipoCliente").value = stipoCliente;
                //document.getElementById("ddlCodigoTipoCliente").value = ;
                document.getElementById("txtFechaInicio").value = sfechaInicio;
                document.getElementById("txtFechaFin").value = sfechaFin;
                document.getElementById("ddlGeneraOrden").value = sGeneraOrden;

                $("#ddlCodigoTipoCliente").val(stipoCliente).change();

            }

        };

        function EliminarPerfil(e) {

            e.preventDefault();
            const scodigoPerfil = e.target.parentElement.parentElement.firstElementChild.textContent;
            Swal.fire({
                title: "¿Desea eliminar el perfil seleccionado?",
                text: "Esta acción no se puede revertir",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'No, cancelar'
            }).then(function (result) {
                if (result.value == true) {
                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("Eliminar", "Perfiles")',
                        data: {
                            'CodigoPerfil': scodigoPerfil,
                        },
                        success: function (r) {
                            //window.location.href = '@Url.Action("Index", "Perfiles")';
                            //swal.fire("Eliminado", "Perfil removido", "info");
                            Swal.fire({
                                title: "Eliminado",
                                text: "Perfil removido",
                                icon: 'info',
                                showCancelButton: false,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'OK'
                            }).then(function (result) {
                                if (result.value == true){
                                    window.location.href = '@Url.Action("Index", "Perfiles")';
                                }
                            })
                        }

                    });
                } else {
                    swal.fire("Cancelado", "Acción Cancelada", "info");
                }
            })

        }


    </script>



}

